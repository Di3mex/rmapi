#!/bin/bash 
#
# Script to annotate remarkable notebooks. Based on the work of:
#   Copyright Â© 2018, Eric S Fraga, e.fraga@ucl.ac.uk
#   $Id: rmannotated.sh,v 1.12 2018/10/07 15:19:09 ucecesf Exp $  
#
# Changed by peer david for the usage of rmapi
#


# Parse input and set defaults
base=$1
id=$2
output=$3
rM2svg=$4
templatesdir="${HOME}/Templates/Remarkable"

# Open folder that contains the .rm files
cd ${base}

# Write annotated pdf
doc="${id}.pdf"
if [ -f ${doc} ]
then
    # Get width and height of pdf
    width=$(pdfinfo ${doc} | grep 'Page size:' | awk '{print $3}')
    height=$(pdfinfo ${doc} | grep 'Page size:' | awk '{print $5}')

    # comparing floating point numbers in bash directly is not possible
    if (( $(echo "$height > $width" |bc -l) )); then
        rotated="no"
    else
        rotated="yes"
        swap=$width
        width=$height
        height=$swap
    fi

    usetemplates="no"
else
    rotate="no"
    width=1404
    height=1872

    if [ -d "${templatesdir}" ];
    then
        usetemplates="yes"
    else
        usetemplates="no"
    fi
fi

# Create svg files
$rM2svg -c -i ${id} --width ${width} --height ${height} -o ""

# Read possible templates 
if [ "$usetemplates" == "yes" ];
then
    readarray -t templates < "$id.pagedata"
fi

# Create a pdf for every svg file
page=0
for svg in *.svg 
do
    p=$(basename $svg .svg)

    if [ "$usetemplates" == "yes" ] && [ "${page}" -lt "${#templates[@]}" ];
    then    
        # Convert template to pdf
        if [ ! -f "${templatesdir}/${templates[$page]}.pdf" ]
        then
            convert "${templatesdir}/${templates[$page]}.png" "${templatesdir}/${templates[$page]}.pdf"
        fi

        # Convert notes to pdf
        rsvg-convert -f pdf -o "${id}_$p_tmp.pdf" "$p.svg"
        #inkscape "$p.svg" --without-gui --export-pdf="${id}_$p_tmp.pdf"

        # Merge template and notes
        pdftk "${id}_$p_tmp.pdf" background "${templatesdir}/${templates[$page]}.pdf" output "${id}_$p.pdf"
        rm "${id}_$p_tmp.pdf"
    else
        rsvg-convert -f pdf -o ${id}_$p.pdf $p.svg
        #inkscape "$p.svg" --without-gui --export-pdf="${id}_$p.pdf"
    fi

    if [ "$rotated" == "yes" ] 
    then
        pdf270 $p.pdf 2>/dev/null
        mv $p-rotated270.pdf $p.pdf
    fi
    page=$((page+1))
done

pdftk  ${id}_*.pdf cat output ${id}_annotations.pdf

if [ -f ${doc} ]; then
    pdftk ${doc} multistamp ${id}_annotations.pdf output ../"${output}.pdf"
else
    mv ${id}_annotations.pdf ../"${output}.pdf"
fi

rm ${id}_*.pdf